<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReFi Orbifier - Transform Your PFP with the ReFi Orb</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Transform your profile picture with the signature ReFi DAO gradient orb. Join the regenerative finance movement with your orbified PFP.">
    <meta name="keywords" content="ReFi, Regenerative Finance, DAO, Profile Picture, PFP, Web3, Blockchain">
    <meta name="author" content="ReFi DAO">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://orbifier.refidao.com/">
    <meta property="og:title" content="ReFi Orbifier - Transform Your PFP">
    <meta property="og:description" content="Transform your profile picture with the signature ReFi DAO gradient orb. Join the regenerative finance movement.">
    <meta property="og:image" content="assets/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://orbifier.refidao.com/">
    <meta name="twitter:title" content="ReFi Orbifier - Transform Your PFP">
    <meta name="twitter:description" content="Transform your profile picture with the signature ReFi DAO gradient orb. Join the regenerative finance movement.">
    <meta name="twitter:image" content="assets/og-image.png">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='none' stroke='url(%23grad)' stroke-width='8'/><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%234571E1'/><stop offset='50%25' style='stop-color:%23DE9AE9'/><stop offset='100%25' style='stop-color:%2371E3BA'/></linearGradient></defs></svg>">

    <!-- Switzer Font from Fontshare -->
    <link href="https://api.fontshare.com/v2/css?f[]=switzer@300,400,500&display=swap" rel="stylesheet">

    <style>
        /* ==================== CSS STYLES ==================== */

        /* CSS Custom Properties (Design Tokens) */
        :root {
            /* ReFi Brand Colors */
            --refi-space: #172027;
            --refi-blue: #4571E1;
            --refi-green: #71E3BA;
            --refi-yellow: #FFFA7E;
            --refi-pink: #DE9AE9;
            --refi-cloud: #F1F0FF;

            /* Semantic Colors */
            --bg-primary: var(--refi-space);
            --bg-secondary: #1e2a33;
            --text-primary: var(--refi-cloud);
            --text-secondary: rgba(241, 240, 255, 0.7);
            --border-color: rgba(241, 240, 255, 0.15);
            --error-color: #ff6b6b;
            --success-color: var(--refi-green);

            /* Typography */
            --font-family: 'Switzer', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.5rem;
            --font-size-2xl: 2rem;

            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        /* Reset & Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-family);
            font-weight: 400;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Background with subtle gradient and noise */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(69, 113, 225, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(222, 154, 233, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(113, 227, 186, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        /* Main Container */
        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Header */
        header {
            text-align: center;
            padding: var(--spacing-2xl) 0 var(--spacing-xl);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-lg);
        }

        .logo svg {
            width: 100%;
            height: 100%;
        }

        h1 {
            font-size: var(--font-size-2xl);
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--refi-cloud) 0%, var(--refi-blue) 50%, var(--refi-pink) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            font-size: var(--font-size-base);
            font-weight: 300;
            color: var(--text-secondary);
        }

        /* Sections */
        section {
            margin-bottom: var(--spacing-xl);
        }

        .section-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
        }

        .section-title {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-md);
        }

        /* Form Elements */
        label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            color: var(--text-primary);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--refi-blue);
            box-shadow: 0 0 0 3px rgba(69, 113, 225, 0.2);
        }

        input[type="text"]::placeholder,
        input[type="password"]::placeholder {
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            font-family: var(--font-family);
            font-size: var(--font-size-sm);
            font-weight: 500;
            text-decoration: none;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            color: var(--refi-space);
            background: linear-gradient(135deg, var(--refi-blue) 0%, var(--refi-pink) 100%);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            color: var(--text-primary);
            background: transparent;
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(241, 240, 255, 0.05);
            border-color: var(--text-secondary);
        }

        .btn-icon {
            padding: var(--spacing-sm);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: color var(--transition-fast), background var(--transition-fast);
        }

        .btn-icon:hover {
            color: var(--text-primary);
            background: rgba(241, 240, 255, 0.1);
        }

        /* Input Group */
        .input-group {
            display: flex;
            gap: var(--spacing-sm);
        }

        .input-group input {
            flex: 1;
        }

        .input-wrapper {
            position: relative;
            flex: 1;
        }

        .input-wrapper input {
            padding-right: 40px;
        }

        .input-wrapper .btn-icon {
            position: absolute;
            right: var(--spacing-xs);
            top: 50%;
            transform: translateY(-50%);
        }

        /* Links */
        a {
            color: var(--refi-blue);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--refi-pink);
        }

        .help-text {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: var(--spacing-sm);
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--refi-blue);
            background: rgba(69, 113, 225, 0.05);
        }

        .upload-zone.dragover {
            transform: scale(1.02);
        }

        .upload-zone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.7;
        }

        .upload-text {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-xs);
        }

        .upload-hint {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* Preview Area */
        .preview-section {
            display: none;
        }

        .preview-section.visible {
            display: block;
        }

        .preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .preview-image {
            width: 300px;
            height: 300px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            background: var(--bg-primary);
        }

        .preview-image img,
        .preview-image canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Loading State */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-2xl);
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--refi-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* Error Message */
        .error-message {
            display: none;
            padding: var(--spacing-md);
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--error-color);
            border-radius: var(--radius-md);
            color: var(--error-color);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-md);
        }

        .error-message.visible {
            display: block;
        }

        /* Success Message */
        .success-message {
            display: none;
            padding: var(--spacing-md);
            background: rgba(113, 227, 186, 0.1);
            border: 1px solid var(--success-color);
            border-radius: var(--radius-md);
            color: var(--success-color);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-md);
        }

        .success-message.visible {
            display: block;
        }

        /* Footer */
        footer {
            margin-top: auto;
            padding: var(--spacing-xl) 0;
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        footer a {
            color: var(--text-secondary);
        }

        footer a:hover {
            color: var(--text-primary);
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: var(--spacing-md);
            }

            h1 {
                font-size: var(--font-size-xl);
            }

            .preview-image {
                width: 250px;
                height: 250px;
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            .action-buttons .btn {
                width: 100%;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo" aria-hidden="true">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="orbGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#4571E1"/>
                            <stop offset="33%" style="stop-color:#71E3BA"/>
                            <stop offset="66%" style="stop-color:#FFFA7E"/>
                            <stop offset="100%" style="stop-color:#DE9AE9"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="42" fill="none" stroke="url(#orbGradient)" stroke-width="8" stroke-linecap="round"/>
                </svg>
            </div>
            <h1>ReFi Orbifier</h1>
            <p class="tagline">Transform your PFP with the ReFi orb</p>
        </header>

        <main>
            <!-- API Key Section -->
            <section id="api-section">
                <div class="section-card">
                    <h2 class="section-title">remove.bg API Key</h2>
                    <div class="input-group">
                        <div class="input-wrapper">
                            <input
                                type="password"
                                id="api-key-input"
                                placeholder="Enter your API key"
                                aria-label="remove.bg API key"
                            >
                            <button
                                type="button"
                                class="btn-icon"
                                id="toggle-key-visibility"
                                aria-label="Toggle API key visibility"
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                        <button type="button" class="btn btn-primary" id="save-api-key">Save</button>
                    </div>
                    <p class="help-text">
                        <a href="https://www.remove.bg/api" target="_blank" rel="noopener noreferrer">Get your free API key</a> (50 images/month free)
                    </p>
                    <div class="success-message" id="api-success">API key saved successfully!</div>
                    <div class="error-message" id="api-error"></div>
                </div>
            </section>

            <!-- Upload Section -->
            <section id="upload-section">
                <div class="section-card">
                    <h2 class="section-title">Upload Your Photo</h2>
                    <div class="upload-zone" id="upload-zone" role="button" tabindex="0" aria-label="Upload photo">
                        <input
                            type="file"
                            id="file-input"
                            accept="image/png,image/jpeg,image/jpg,image/webp"
                            aria-describedby="upload-hint"
                        >
                        <div class="upload-icon">ðŸ“·</div>
                        <p class="upload-text">Drop your photo here or click to browse</p>
                        <p class="upload-hint" id="upload-hint">PNG, JPG, or WEBP up to 10MB</p>
                    </div>
                    <div class="error-message" id="upload-error"></div>
                </div>
            </section>

            <!-- Loading Section -->
            <section class="loading" id="loading-section" aria-live="polite">
                <div class="spinner" aria-hidden="true"></div>
                <p class="loading-text" id="loading-text">Processing your image...</p>
            </section>

            <!-- Preview Section -->
            <section class="preview-section" id="preview-section">
                <div class="section-card">
                    <h2 class="section-title">Your Orbified PFP</h2>
                    <div class="preview-container">
                        <div class="preview-image">
                            <canvas id="preview-canvas" width="400" height="400" aria-label="Orbified profile picture preview"></canvas>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-primary" id="download-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Download PNG
                            </button>
                            <button type="button" class="btn btn-secondary" id="share-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                                </svg>
                                Share on X
                            </button>
                        </div>
                        <button type="button" class="btn btn-secondary" id="reset-btn">Create Another</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p>Made with ðŸ’š for the ReFi community</p>
            <p>Built by <a href="https://x.com/iamjohnellison" target="_blank" rel="noopener noreferrer">@iamjohnellison</a></p>
        </footer>
    </div>

    <script>
        // ==================== JAVASCRIPT ====================

        // DOM Elements
        const apiKeyInput = document.getElementById('api-key-input');
        const toggleKeyBtn = document.getElementById('toggle-key-visibility');
        const saveApiKeyBtn = document.getElementById('save-api-key');
        const apiSuccess = document.getElementById('api-success');
        const apiError = document.getElementById('api-error');

        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const uploadError = document.getElementById('upload-error');

        const loadingSection = document.getElementById('loading-section');
        const loadingText = document.getElementById('loading-text');

        const previewSection = document.getElementById('preview-section');
        const previewCanvas = document.getElementById('preview-canvas');
        const downloadBtn = document.getElementById('download-btn');
        const shareBtn = document.getElementById('share-btn');
        const resetBtn = document.getElementById('reset-btn');

        const ctx = previewCanvas.getContext('2d');

        // State
        let currentApiKey = localStorage.getItem('removebg_api_key') || '';
        let processedImageData = null;
        let orbImage = null;

        // Preload the orb image
        function preloadOrbImage() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    orbImage = img;
                    resolve(img);
                };
                img.onerror = () => reject(new Error('Failed to load orb image'));
                img.src = 'assets/reFiPodcast-Lion@2x.png';
            });
        }

        // Load orb image on page load
        preloadOrbImage().catch(console.error);

        // Initialize
        function init() {
            // Load saved API key
            if (currentApiKey) {
                apiKeyInput.value = currentApiKey;
            }

            // Event Listeners
            toggleKeyBtn.addEventListener('click', toggleKeyVisibility);
            saveApiKeyBtn.addEventListener('click', saveApiKey);

            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            uploadZone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    fileInput.click();
                }
            });

            downloadBtn.addEventListener('click', downloadImage);
            shareBtn.addEventListener('click', shareToX);
            resetBtn.addEventListener('click', resetApp);
        }

        // API Key Management
        function toggleKeyVisibility() {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            toggleKeyBtn.setAttribute('aria-label', isPassword ? 'Hide API key' : 'Show API key');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();

            hideMessages();

            if (!key) {
                showError(apiError, 'Please enter an API key');
                return;
            }

            // Basic validation - remove.bg keys are typically 20+ characters
            if (key.length < 10) {
                showError(apiError, 'API key seems too short. Please check and try again.');
                return;
            }

            currentApiKey = key;
            localStorage.setItem('removebg_api_key', key);
            showSuccess(apiSuccess);
        }

        // File Upload
        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function processFile(file) {
            hideMessages();

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showError(uploadError, 'Please upload a PNG, JPG, or WEBP image');
                return;
            }

            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showError(uploadError, 'Image must be under 10MB');
                return;
            }

            // Check for API key
            if (!currentApiKey) {
                showError(uploadError, 'Please save your API key first');
                return;
            }

            // Process the image
            processImage(file);
        }

        // Image Processing
        async function processImage(file) {
            showLoading('Removing background...');

            try {
                // Step 1: Remove background
                const transparentImage = await removeBackground(file);

                setLoadingText('Creating your orb...');

                // Step 2: Composite with orb
                await compositeImage(transparentImage);

                // Step 3: Show preview
                hideLoading();
                previewSection.classList.add('visible');

            } catch (error) {
                hideLoading();
                showError(uploadError, error.message);
            }
        }

        async function removeBackground(file) {
            const formData = new FormData();
            formData.append('image_file', file);
            formData.append('size', 'auto');

            const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                method: 'POST',
                headers: {
                    'X-Api-Key': currentApiKey,
                },
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));

                if (response.status === 402) {
                    throw new Error('Insufficient API credits. Please upgrade your remove.bg plan or wait for credits to reset.');
                } else if (response.status === 401) {
                    throw new Error('Invalid API key. Please check and update your key.');
                } else if (response.status === 400) {
                    throw new Error(errorData.errors?.[0]?.title || 'Invalid image. Please try a different photo.');
                } else {
                    throw new Error('Failed to remove background. Please try again.');
                }
            }

            const blob = await response.blob();
            return createImageBitmap(blob);
        }

        async function compositeImage(foregroundImage) {
            const canvas = previewCanvas;
            const size = 400;

            // Clear canvas
            ctx.clearRect(0, 0, size, size);

            // Ensure orb image is loaded
            if (!orbImage) {
                await preloadOrbImage();
            }

            // Step 1: Draw the orb image as background (it includes the dark bg + orb)
            ctx.drawImage(orbImage, 0, 0, size, size);

            // Step 2: Draw foreground image (centered and scaled)
            const scale = Math.min(size / foregroundImage.width, size / foregroundImage.height) * 0.85;
            const scaledWidth = foregroundImage.width * scale;
            const scaledHeight = foregroundImage.height * scale;
            const x = (size - scaledWidth) / 2;
            const y = (size - scaledHeight) / 2;

            ctx.drawImage(foregroundImage, x, y, scaledWidth, scaledHeight);

            // Store processed image data
            processedImageData = canvas.toDataURL('image/png');
        }

        // Download
        function downloadImage() {
            if (!processedImageData) return;

            const link = document.createElement('a');
            link.download = 'refi-orbified-pfp.png';
            link.href = processedImageData;
            link.click();
        }

        // Share to X
        function shareToX() {
            const tweetText = `Just orbified my PFP with the ReFi Orbifier! ðŸŒˆ

Thanks @ReFiDAOist & @iamjohnellison for this awesome tool!

#ReFi #RegenerativeFinance

[Attach your downloaded image]`;

            const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
            window.open(tweetUrl, '_blank', 'width=550,height=420');
        }

        // Reset
        function resetApp() {
            previewSection.classList.remove('visible');
            fileInput.value = '';
            processedImageData = null;
            ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            hideMessages();
        }

        // UI Helpers
        function showLoading(text) {
            loadingText.textContent = text;
            loadingSection.classList.add('visible');
        }

        function setLoadingText(text) {
            loadingText.textContent = text;
        }

        function hideLoading() {
            loadingSection.classList.remove('visible');
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.add('visible');
        }

        function showSuccess(element) {
            element.classList.add('visible');
            setTimeout(() => {
                element.classList.remove('visible');
            }, 3000);
        }

        function hideMessages() {
            apiSuccess.classList.remove('visible');
            apiError.classList.remove('visible');
            uploadError.classList.remove('visible');
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
